<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PATCHWORK // The Firm // Text Terminal</title>
  <style>
    /* --- Terminal Aesthetic --- */
    :root {
      --bg: #000000;
      --crt: #00d46f; /* monochrome green */
      --crt-dim: #009a4d;
      --accent: #00ff94;
      --amber: #ffb300; /* optional secondary */
      --muted: #0a2f1c;
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--crt);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      line-height: 1.6;
    }
    .terminal {
      max-width: 860px;
      margin: 0 auto;
      padding: 24px 18px 48px;
      position: relative;
      /* very subtle CRT scanlines */
      background-image: linear-gradient(
        rgba(0, 255, 100, 0.04) 2px,
        rgba(0, 0, 0, 0.06) 2px
      );
      background-size: 100% 4px;
    }
    /* Surveillance Eyes */
    .eyesbar {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      margin: 8px 0 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--crt-dim);
    }
    .eyes {
      font-size: 52px;
      letter-spacing: 0.08em;
      user-select: none;
      transition: color 180ms ease, text-shadow 180ms ease;
      text-shadow: 0 0 8px rgba(0,255,100,0.2);
    }
    .eyes.neutral { color: var(--crt); }
    .eyes.alert { color: var(--accent); }
    .eyes.suspicious { color: var(--amber); }
    .eyes.high { color: #ff5a00; }
    .eyes .blink {
      animation: blink 6s infinite;
      display: inline-block;
    }
    @keyframes blink {
      0%, 97%, 100% { opacity: 1; }
      98% { opacity: 0.15; }
      99% { opacity: 1; }
    }
    .status {
      color: var(--crt-dim);
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
      color: var(--accent);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .brand {
      user-select: none;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button {
      background: transparent;
      color: var(--crt);
      border: 1px solid var(--crt);
      padding: 6px 10px;
      font: inherit;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease, border-color 120ms ease;
    }
    button:hover, button:focus-visible {
      outline: none;
      background: var(--muted);
      border-color: var(--accent);
      color: var(--accent);
    }
    .output {
      white-space: pre-wrap; /* keep line breaks */
      min-height: 220px;
      padding: 10px 0 4px;
      font-size: 16px;
    }
    .choices {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 12px;
    }
    .choices .choice {
      text-align: left;
    }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--crt-dim), transparent);
      margin: 14px 0;
      opacity: 0.6;
    }
    .hint {
      color: var(--crt-dim);
      font-size: 12px;
    }
    .marker {
      color: var(--amber);
    }
    /* Archives overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      display: none;
      z-index: 10;
      overflow: auto;
      padding: 28px 14px 48px;
    }
    .overlay.active { display: block; }
    .overlay .grid {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .card {
      border: 1px solid var(--crt-dim);
      padding: 12px;
      background: #02150c;
    }
    .card h3 {
      margin: 0 0 6px;
      color: var(--accent);
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .card p { margin: 8px 0; }
    .overlay .closebar {
      max-width: 960px;
      margin: 0 auto 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    @media (min-width: 640px) {
      .choices { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="terminal" role="application" aria-label="Patchwork Terminal">
    <div class="header">
      <div class="brand">PATCHWORK // THE FIRM // TERMINAL</div>
      <div class="toolbar">
        <button id="audioToggle" title="Toggle audio">AUDIO: ON</button>
        <button id="archivesBtn" aria-haspopup="dialog" aria-controls="archives">ACCESS ARCHIVES</button>
        <button id="storyMapBtn" aria-haspopup="dialog" aria-controls="storyMap">STORY MAP</button>
        <button id="typeToggle" title="Toggle slow typing">TYPE: SLOW</button>
          <button id="playPauseBtn" title="Play/Pause radio broadcast">BROADCAST: PLAY</button>
          <button id="restartAudioBtn" title="Restart radio broadcast">BROADCAST: RESTART</button>
          <button id="restartBtn" title="Restart game">RESTART</button>
      </div>
    </div>
    <div class="eyesbar">
      <div id="eyes" class="eyes neutral" aria-hidden="true">◥<span class="blink">●</span>◣  ◥<span class="blink">●</span>◣</div>
      <div id="status" class="status">PALANTIR STATUS: MONITORING</div>
    </div>
    <div class="divider" aria-hidden="true"></div>

    <div id="output" class="output" aria-live="polite"></div>
    <div id="choices" class="choices"></div>
    <div class="hint">Use the options to proceed. Refresh to replay.</div>
  </div>

  <!-- Archives Overlay -->
  <div id="archives" class="overlay" role="dialog" aria-modal="true" aria-labelledby="archivesTitle">
    <div class="closebar">
      <div id="archivesTitle" class="brand">ARCHIVES // THE FIRM // EDUCATIONAL CARDS</div>
      <button id="closeArchives">Close</button>
    </div>
    <div id="archivesGrid" class="grid"></div>
  </div>
  

  <!-- Story Map Overlay (simple outline, no external libs) -->
  <div id="storyMap" class="overlay" role="dialog" aria-modal="true" aria-labelledby="storyMapTitle">
    <div class="closebar">
      <div id="storyMapTitle" class="brand">STORY MAP // OUTLINE</div>
      <button id="closeStoryMap">Close</button>
    </div>
    <div class="grid">
      <section class="card">
        <div id="storyMapContent" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <script src="story.js"></script>
  <script>
    // --- DOM refs ---
    const output = document.getElementById('output');
    const choicesEl = document.getElementById('choices');
    const archives = document.getElementById('archives');
    const archivesBtn = document.getElementById('archivesBtn');
    const closeArchives = document.getElementById('closeArchives');
    const typeToggle = document.getElementById('typeToggle');
    const restartBtn = document.getElementById('restartBtn');
    const audioToggle = document.getElementById('audioToggle');
    const eyesEl = document.getElementById('eyes');
    const statusEl = document.getElementById('status');
    
    const archivesGrid = document.getElementById('archivesGrid');
    const storyMapOverlay = document.getElementById('storyMap');
    const storyMapBtn = document.getElementById('storyMapBtn');
    const closeStoryMap = document.getElementById('closeStoryMap');
    const storyMapContent = document.getElementById('storyMapContent');
    
    // --- Audio setup ---
    const radioBroadcast = new Audio('Radio Broadcast.wav');
    radioBroadcast.preload = 'auto';
    radioBroadcast.crossOrigin = 'anonymous';
    const playPauseBtn = document.getElementById('playPauseBtn');
    const restartAudioBtn = document.getElementById('restartAudioBtn');
    
      // --- Game state ---
    const state = {
      scene: 'intro',
      role: null,
      decisionIndex: 0,
      stabilityScore: 0,
      fractureScore: 0,
      surveillanceLevel: 0, // 0 neutral, 1 alert, 2 suspicious, 3 high
      slowType: true,
      audioEnabled: true
    };

    // --- UI wiring ---
    archivesBtn.addEventListener('click', () => openArchives());
    closeArchives.addEventListener('click', () => archives.classList.remove('active'));
    restartBtn.addEventListener('click', () => restart());
    typeToggle.addEventListener('click', () => {
      state.slowType = !state.slowType;
      typeToggle.textContent = state.slowType ? 'TYPE: SLOW' : 'TYPE: INSTANT';
    });
    audioToggle.addEventListener('click', () => {
      state.audioEnabled = !state.audioEnabled;
      audioToggle.textContent = state.audioEnabled ? 'AUDIO: ON' : 'AUDIO: OFF';
      if (!state.audioEnabled) radioBroadcast.pause();
    });
    
      playPauseBtn.addEventListener('click', () => {
        if (radioBroadcast.paused) {
          radioBroadcast.play();
          playPauseBtn.textContent = 'BROADCAST: PAUSE';
        } else {
          radioBroadcast.pause();
          playPauseBtn.textContent = 'BROADCAST: PLAY';
        }
      });
      restartAudioBtn.addEventListener('click', () => {
        radioBroadcast.currentTime = 0;
        if (state.audioEnabled) {
          radioBroadcast.play();
          playPauseBtn.textContent = 'BROADCAST: PAUSE';
        }
      });
      
      storyMapBtn.addEventListener('click', () => openStoryMap());
      closeStoryMap.addEventListener('click', () => storyMapOverlay.classList.remove('active'));

    // --- Helpers ---
    function openArchives() {
      // Populate from STORY only once
      if (!archivesGrid.dataset.loaded) {
        STORY.archives.forEach(card => {
          const section = document.createElement('section');
          section.className = 'card';
          const h = document.createElement('h3');
          h.textContent = card.title;
          section.appendChild(h);
          card.paragraphs.forEach(p => {
            const para = document.createElement('p');
            para.textContent = p;
            section.appendChild(para);
          });
          archivesGrid.appendChild(section);
        });
        archivesGrid.dataset.loaded = 'true';
      }
      archives.classList.add('active');
    }

    async function renderText(text) {
      choicesEl.innerHTML = '';
      output.textContent = '';
      const full = String(text);
      if (!state.slowType) {
        output.textContent = full;
        return;
      }
      const speed = 12;
      for (let i = 0; i < full.length; i++) {
        output.textContent += full[i];
        const c = full[i];
        let delay = speed;
        if (c === '\n') delay = 120;
        else if (c === '.') delay = 24;
        await new Promise(r => setTimeout(r, delay));
      }
    }

    function renderChoices(options) {
      choicesEl.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'choice';
        btn.textContent = opt.label;
        btn.addEventListener('click', () => {
          if (typeof opt.onChoose === 'function') opt.onChoose();
          if (opt.next) opt.next();
        });
        choicesEl.appendChild(btn);
      });
    }

    function setEyes(level) {
      state.surveillanceLevel = Math.max(0, Math.min(3, level));
      const map = {
        0: { cls: 'neutral', art: '◥<span class="blink">●</span>◣  ◥<span class="blink">●</span>◣', status: 'PALANTIR STATUS: MONITORING' },
        1: { cls: 'alert', art: '◥<span class="blink">◎</span>◣  ◥<span class="blink">◎</span>◣', status: 'PALANTIR STATUS: EVALUATING' },
        2: { cls: 'suspicious', art: '◥<span class="blink">■</span>◣  ◥<span class="blink">■</span>◣', status: 'PALANTIR STATUS: FLAGGING' },
        3: { cls: 'high', art: '◥<span class="blink">◉</span>◣  ◥<span class="blink">◉</span>◣', status: 'PALANTIR STATUS: INTERVENING' }
      };
      const v = map[state.surveillanceLevel];
      eyesEl.className = `eyes ${v.cls}`;
      eyesEl.innerHTML = v.art;
      statusEl.textContent = v.status;
    }

    function bumpSurveillance(fractureBias = false) {
      const delta = fractureBias ? 1 : 0;
      setEyes(state.surveillanceLevel + delta);
    }

    

    // --- Story Map (Simple Outline) ---
    function makeEl(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text != null) el.textContent = text;
      return el;
    }

    function openStoryMap() {
      storyMapContent.innerHTML = '';
      const title = makeEl('h3', null, 'Story Progression');
      title.style.marginTop = '0';
      storyMapContent.appendChild(title);

      const p = makeEl('p', null, 'Overview of choices and endings.');
      storyMapContent.appendChild(p);

      const rootList = document.createElement('ul');
      rootList.style.marginTop = '8px';
      rootList.style.lineHeight = '1.45';
      const introItem = makeEl('li', null, 'Intro Broadcast');
      rootList.appendChild(introItem);

      const rolesList = document.createElement('ul');
      introItem.appendChild(rolesList);

      const roles = STORY.roles || {};
      Object.keys(roles).forEach((key) => {
        const role = roles[key];
        const roleItem = makeEl('li', null, role.title || key);
        rolesList.appendChild(roleItem);

        const decsList = document.createElement('ul');
        roleItem.appendChild(decsList);

        const decs = role.decisions || [];
        decs.forEach((d, idx) => {
          const firstLine = String(d.question || '').split('\n')[0] || `Decision ${idx+1}`;
          const decItem = makeEl('li', null, firstLine);
          decsList.appendChild(decItem);

          const optsList = document.createElement('ul');
          decItem.appendChild(optsList);
          (d.options || []).forEach((opt) => {
            const optItem = makeEl('li', null, `${opt.label} [${opt.effect}]`);
            optsList.appendChild(optItem);
          });
        });

        const tallyItem = makeEl('li', null, 'Score Tally → Ending');
        const tallyList = document.createElement('ul');
        tallyItem.appendChild(tallyList);
        tallyList.appendChild(makeEl('li', null, 'Ending: System-Stable (stability ≥ fracture)'));
        tallyList.appendChild(makeEl('li', null, 'Ending: System-Fracture (fracture > stability)'));
        decsList.appendChild(tallyItem);
      });

      storyMapContent.appendChild(rootList);
      storyMapOverlay.classList.add('active');
    }

    // --- Scene Logic ---
    async function intro() {
      await renderText(STORY.introBroadcast);
      // Note: Autoplay is blocked by browsers; user must click BROADCAST: PLAY button
      renderChoices([
        { label: 'Select Role: Human Capital Unit / Citizen', next: () => roleBrief('citizen') },
        { label: 'Select Role: Monarch-CEO', next: () => roleBrief('monarch') },
        { label: 'Select Role: Cathedral / Democratic Rebellion Member', next: () => roleBrief('cathedral') }
      ]);
      setEyes(0);
    }

    async function roleBrief(roleKey) {
      state.role = roleKey;
      state.decisionIndex = 0;
      const role = STORY.roles[roleKey];
      await renderText([ '[RADIO BROADCAST]', role.description ].join('\n'));
      renderChoices([
        { label: 'Proceed to Decisions', next: () => renderDecision(roleKey, 0) },
        { label: 'ACCESS ARCHIVES', next: () => openArchives() }
      ]);
      if (roleKey === 'cathedral') bumpSurveillance(true);
    }

    async function renderDecision(roleKey, idx) {
      const role = STORY.roles[roleKey];
      const d = role.decisions[idx];
      state.decisionIndex = idx;
      await renderText([ '[RADIO BROADCAST]', d.question ].join('\n'));
      const options = d.options.map(opt => ({
        label: opt.label,
        next: () => {
          if (opt.effect === 'stability') state.stabilityScore++;
          if (opt.effect === 'fracture') state.fractureScore++;
          if (opt.effect === 'fracture' || roleKey === 'antichrist' || opt.flagsSurveillance) bumpSurveillance(true);
          const nextIdx = idx + 1;
          if (nextIdx < role.decisions.length) renderDecision(roleKey, nextIdx);
          else ending(roleKey);
        }
      }));
      // INFO removed per request; show only decision options
      renderChoices(options);
    }

    async function ending(roleKey) {
      const role = STORY.roles[roleKey];
      const stable = state.stabilityScore >= state.fractureScore;
      const text = stable ? role.endings.systemStable : role.endings.systemFracture;
      await renderText(text);
      renderChoices([{ label: 'RESTART', next: () => restart() }]);
    }

    function restart() {
      state.scene = 'intro';
      state.role = null;
      state.decisionIndex = 0;
      state.stabilityScore = 0;
      state.fractureScore = 0;
      setEyes(0);
      intro();
    }

    // --- Init ---
    intro();
  </script>
</body>
</html>
